<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>从 Oryx 拉流播放</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
    }
    h1 { font-size: 18px; margin: 0 0 12px; color: #fff; }
    .player-wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      max-height: 50vh;
      background: #0f0f1a;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    #remoteVideo {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #000;
    }
    .player-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 14px;
      text-align: center;
      padding: 16px;
    }
    .status {
      padding: 10px 12px;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 12px;
      min-height: 40px;
    }
    .status.error { color: #ff6b6b; }
    .status.ok { color: #51cf66; }
    .status.pending { color: #ffd43b; }
    .btn-wrap { display: flex; gap: 12px; margin-bottom: 12px; }
    button {
      flex: 1;
      padding: 14px 20px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:active { opacity: 0.8; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    #btnPlay { background: linear-gradient(135deg, #2f9e44, #228be6); color: #fff; }
    #btnStop { background: #495057; color: #fff; }
    .tip { font-size: 12px; color: #868e96; margin-top: 12px; line-height: 1.5; }
    .play-urls {
      margin-top: 16px;
      padding: 12px;
      background: rgba(255,255,255,0.06);
      border-radius: 8px;
      font-size: 12px;
    }
    .play-title { font-size: 14px; margin: 0 0 10px; color: #fff; }
    .play-item { margin: 6px 0; word-break: break-all; }
    .play-item a { color: #74c0fc; text-decoration: none; }
    .play-item a:active { opacity: 0.8; }
  </style>
</head>
<body>
  <h1>从 Oryx 拉流播放</h1>
  <div class="player-wrap">
    <video id="remoteVideo" autoplay playsinline></video>
    <div class="player-placeholder" id="placeholder">点击「播放」从 Oryx 拉取直播流（WebRTC）</div>
  </div>
  <div class="status pending" id="status">就绪</div>
  <div class="btn-wrap">
    <button id="btnPlay">播放</button>
    <button id="btnStop" disabled>停止</button>
  </div>
  <p class="tip">此页从 Oryx 拉流播放，流由 SRS 推至 Oryx。需用 <strong>HTTPS 或 localhost</strong> 打开。</p>
  <section class="play-urls">
    <h2 class="play-title">Oryx 其他协议</h2>
    <p class="play-item"><strong>HTTP-FLV</strong> <a href="#" id="linkFlv" target="_blank" rel="noopener">-</a></p>
    <p class="play-item"><strong>HLS</strong> <a href="#" id="linkHls" target="_blank" rel="noopener">-</a></p>
    <p class="play-item"><strong>WebRTC (WHEP)</strong> <a href="#" id="linkWhep" target="_blank" rel="noopener">-</a></p>
  </section>

  <script>
    (function () {
      // ========== 配置：改成你的 Oryx 地址（不要末尾斜杠） ==========
      var ORYX_BASE = 'https://your-oryx-domain.com';
      var ORYX_APP = 'live';
      var ORYX_STREAM = 'livestream';

      var WHEP_URL = ORYX_BASE + '/rtc/v1/whep/?app=' + ORYX_APP + '&stream=' + ORYX_STREAM;
      var FLV_URL = ORYX_BASE + '/live/' + ORYX_STREAM + '.flv';
      var HLS_URL = ORYX_BASE + '/live/' + ORYX_STREAM + '.m3u8';

      var remoteVideo = document.getElementById('remoteVideo');
      var placeholder = document.getElementById('placeholder');
      var statusEl = document.getElementById('status');
      var btnPlay = document.getElementById('btnPlay');
      var btnStop = document.getElementById('btnStop');
      var linkFlv = document.getElementById('linkFlv');
      var linkHls = document.getElementById('linkHls');
      var linkWhep = document.getElementById('linkWhep');

      linkFlv.href = FLV_URL;
      linkFlv.textContent = FLV_URL;
      linkHls.href = HLS_URL;
      linkHls.textContent = HLS_URL;
      linkWhep.href = WHEP_URL;
      linkWhep.textContent = WHEP_URL;

      var pc = null;
      var whepResourceUrl = null;

      function setStatus(text, type) {
        statusEl.textContent = text;
        statusEl.className = 'status ' + (type || 'pending');
      }

      function setPlayerVisible(visible) {
        remoteVideo.style.display = visible ? 'block' : 'none';
        placeholder.style.display = visible ? 'none' : 'flex';
      }

      async function startPlay() {
        btnPlay.disabled = true;
        setStatus('正在连接 Oryx…', 'pending');
        try {
          var res = await fetch(WHEP_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/sdp' },
            body: ''
          });
          if (!res.ok) {
            var text = await res.text();
            throw new Error('Oryx 返回 ' + res.status + (text ? ': ' + text.slice(0, 150) : ''));
          }
          whepResourceUrl = res.headers.get('Location') || res.url;
          var offerSdp = await res.text();
          pc = new RTCPeerConnection({
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
          });
          pc.ontrack = function (e) {
            if (e.streams && e.streams[0]) {
              remoteVideo.srcObject = e.streams[0];
            } else if (e.track) {
              var s = new MediaStream();
              s.addTrack(e.track);
              remoteVideo.srcObject = s;
            }
            setPlayerVisible(true);
          };
          pc.addEventListener('connectionstatechange', function () {
            if (pc && pc.connectionState === 'failed') {
              setStatus('连接失败，请检查 Oryx 地址与网络', 'error');
            }
          });
          await pc.setRemoteDescription({ type: 'offer', sdp: offerSdp });
          var answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          var patchRes = await fetch(whepResourceUrl, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/sdp' },
            body: pc.localDescription.sdp
          });
          if (!patchRes.ok) {
            var t = await patchRes.text();
            throw new Error('PATCH ' + patchRes.status + (t ? ': ' + t.slice(0, 100) : ''));
          }
          setStatus('已从 Oryx 拉流，正在播放', 'ok');
          btnStop.disabled = false;
        } catch (e) {
          setStatus('拉流失败: ' + (e.message || e.name), 'error');
          stopPlay();
          btnPlay.disabled = false;
        }
      }

      function stopPlay() {
        if (pc) {
          pc.close();
          pc = null;
        }
        whepResourceUrl = null;
        remoteVideo.srcObject = null;
        setPlayerVisible(false);
        setStatus('已停止', 'pending');
        btnPlay.disabled = false;
        btnStop.disabled = true;
      }

      btnPlay.addEventListener('click', startPlay);
      btnStop.addEventListener('click', stopPlay);
    })();
  </script>
</body>
</html>
